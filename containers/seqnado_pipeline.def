BootStrap: docker
From: mambaorg/micromamba:debian-slim

%files
  environment_pipeline.yml /opt/environment_pipeline.yml
  multiqc_config.yaml /opt/seqnado/multiqc_config.yaml
  seqnado.png /opt/seqnado/seqnado.png

%post
  set -e

  # Update and install only minimal build tools
  apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    curl ca-certificates gcc g++ make cmake git pkg-config jq \
    libssl-dev zlib1g-dev libbz2-dev liblzma-dev wget unzip \
    && rm -rf /var/lib/apt/lists/*
  
  # Micromamba environment setup (ensure Python <3.12)
  micromamba install -y -n base -f /opt/environment_pipeline.yml
  micromamba clean -afy

  # Install latest BamNado binary
  echo "Downloading latest BamNado..."
  LATEST_TAG=$(curl -s https://api.github.com/repos/alsmith151/BamNado/releases/latest | jq -r '.tag_name')
  [ "$LATEST_TAG" = "null" ] && LATEST_TAG="v0.3.5"
  curl -L -f --retry 3 --retry-delay 5 -o /opt/conda/bin/bamnado \
    "https://github.com/alsmith151/BamNado/releases/download/${LATEST_TAG}/bamnado-linux-x86_64"
  chmod +x /opt/conda/bin/bamnado
  /opt/conda/bin/python -m pip cache purge

  # Remove build tools
  apt-get purge -y gcc g++ make cmake git pkg-config jq libssl-dev \
    zlib1g-dev libbz2-dev liblzma-dev wget unzip && apt-get autoremove -y && apt-get clean

  # Remove unnecessary data and dev files
  find /opt/conda/ -type f -name '*.a' -delete
  find /opt/conda/ -type f -name '*.pyc' -delete
  find /opt/conda/ -name '__pycache__' -type d -exec rm -rf {} +
  find /opt/conda/ -name '*.egg-info' -type d -exec rm -rf {} +
  find /opt/conda/ -name 'tests' -type d -exec rm -rf {} +
  find /opt/conda/ -name 'locale' -type d -exec rm -rf {} +
  find /opt/conda/ -type d -name 'share' -exec rm -rf {} +
  rm -rf /root/.cache /opt/conda/pkgs

%environment
  export PATH="/opt/conda/bin:$PATH"
  export CONDA_DEFAULT_ENV=base
  export CONDA_PREFIX="/opt/conda"
  export LD_LIBRARY_PATH="/usr/lib:/lib:$LD_LIBRARY_PATH"
  export MAMBA_ROOT_PREFIX="/opt/conda"

%runscript
  exec "$@"

%test
  echo "Testing minimal container..."
  python --version
  bamnado --help > /dev/null 2>&1 && echo "BamNado test passed" || exit 1
  echo "All tests passed!"

%labels
  Author asmith
  Version 0.4.0
  Description Minimal SeqNado container with BamNado and Python tools
  BamNado.Version dynamic
  BuildDate $(date '+%Y-%m-%d')

%help
  This is a lightweight SeqNado container with:
  - Python 3.x (glibc-based)
  - Latest BamNado (downloaded at build)
  - Core bioinformatics tools (from `environment_pipeline.yml`)
  - MACS2, MultiQC, etc.