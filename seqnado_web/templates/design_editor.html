{% extends "layout.html" %}

{% block head %}
<!-- Using a simple editable table implementation or lightweight grid -->
<style>
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
    }

    .data-table th,
    .data-table td {
        border: 1px solid var(--border);
        padding: 0.5rem;
    }

    .data-table th {
        background-color: var(--bg-dark);
        text-align: left;
    }

    .data-table input {
        width: 100%;
        border: none;
        background: transparent;
        color: inherit;
        padding: 0.25rem;
    }

    .data-table input:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.05);
    }

    .delete-row {
        color: var(--danger);
        cursor: pointer;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h1>Edit Design</h1>
        <p class="text-muted">{{ filename }}</p>
    </div>
    <div style="display: flex; gap: 0.5rem;">
        <button type="button" onclick="saveDesign()" class="btn btn-primary">
            <i class="fa-solid fa-save"></i> Save Changes
        </button>
        <a href="{{ url_for('designs_list') }}" class="btn btn-outline">Back</a>
    </div>
</header>

<div class="card" style="overflow-x: auto;">
    <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
        <button type="button" onclick="addRow()" class="btn btn-outline" style="font-size: 0.8rem;">
            <i class="fa-solid fa-plus"></i> Add Row
        </button>
        <button type="button" onclick="addColumn()" class="btn btn-outline" style="font-size: 0.8rem;">
            <i class="fa-solid fa-plus"></i> Add Column
        </button>
    </div>

    <table id="designTable" class="data-table">
        <thead>
            <tr id="headerRow">
                <!-- Headers generated by JS -->
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- Rows generated by JS -->
        </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
<script>
    let designData = {{ data | tojson }};
    const filename = "{{ filename }}";

    // Initial columns from data or default
    let columns = [];
    if (designData.length > 0) {
        columns = Object.keys(designData[0]);
    } else {
        columns = ["SampleName", "Condition", "Replicate"];
    }

    function renderTable() {
        const headerRow = document.getElementById('headerRow');
        const tableBody = document.getElementById('tableBody');

        // Headers
        headerRow.innerHTML = '';
        columns.forEach((col, index) => {
            const th = document.createElement('th');
            const input = document.createElement('input');
            input.value = col;
            input.onchange = (e) => updatecolumnName(index, e.target.value);
            th.appendChild(input);
            headerRow.appendChild(th);
        });
        // Actions column header
        const thAction = document.createElement('th');
        thAction.style.width = "40px";
        headerRow.appendChild(thAction);

        // Body
        tableBody.innerHTML = '';
        designData.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            columns.forEach(col => {
                const td = document.createElement('td');
                const input = document.createElement('input');
                input.value = row[col] || '';
                input.onchange = (e) => updateCell(rowIndex, col, e.target.value);
                td.appendChild(input);
                tr.appendChild(td);
            });

            // Delete button
            const tdAction = document.createElement('td');
            tdAction.className = 'delete-row';
            tdAction.innerHTML = '<i class="fa-solid fa-trash"></i>';
            tdAction.onclick = () => deleteRow(rowIndex);
            tr.appendChild(tdAction);

            tableBody.appendChild(tr);
        });
    }

    function updatecolumnName(index, newName) {
        if (!newName) return;
        const oldName = columns[index];
        columns[index] = newName;

        // Update all rows with new key
        designData = designData.map(row => {
            row[newName] = row[oldName];
            delete row[oldName];
            return row;
        });
        renderTable();
    }

    function updateCell(rowIndex, col, value) {
        designData[rowIndex][col] = value;
    }

    function addRow() {
        const newRow = {};
        columns.forEach(col => newRow[col] = "");
        designData.push(newRow);
        renderTable();
    }

    function addColumn() {
        const newColName = "NewColumn" + (columns.length + 1);
        columns.push(newColName);
        designData.forEach(row => row[newColName] = "");
        renderTable();
    }

    function deleteRow(index) {
        designData.splice(index, 1);
        renderTable();
    }

    async function saveDesign() {
        try {
            const response = await fetch("{{ url_for('api_save_design') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    filename: filename,
                    data: designData
                })
            });

            if (response.ok) {
                alert("Design saved successfully!");
            } else {
                alert("Failed to save design.");
            }
        } catch (e) {
            alert("Error saving: " + e);
        }
    }

    // Initialize
    if (designData.length === 0) {
        addRow(); // Start with empty row if empty
    } else {
        renderTable();
    }
</script>
{% endblock %}