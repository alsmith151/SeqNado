import os
from pathlib import Path
import glob
import yaml

from seqnado.cli import config
from seqnado.outputs.multiomics import find_assay_configs, MultiomicsOutput
from seqnado.config.multiomics import MultiomicsConfig

################################
# Auto-detect assay configs
################################

# Discover available assays
ASSAY_CONFIGS, METADATA_FILES = find_assay_configs(Path("."))
ASSAYS = sorted(list(ASSAY_CONFIGS.keys()))

if not ASSAYS:
    raise ValueError(
        "No config_*.yaml files found in the current directory. "
        "Please create config files using 'seqnado config <assay>'"
    )

print(f"[Multi-Assay Mode] Detected {len(ASSAYS)} assay(s): {', '.join(ASSAYS)}")


################################
# Configuration
################################

# Load multiomics config if it exists
MULTIOMICS_CONFIG_PATH = Path("config_multiomics.yaml")
if MULTIOMICS_CONFIG_PATH.exists():
    with open(MULTIOMICS_CONFIG_PATH, 'r') as f:
        multiomics_config_dict = yaml.safe_load(f)
    MULTIOMICS_CONFIG = MultiomicsConfig(**multiomics_config_dict)
    print(f"[Multi-Assay Mode] Loaded multiomics config: {MULTIOMICS_CONFIG_PATH}")
else:
    # Use defaults if no multiomics config
    MULTIOMICS_CONFIG = MultiomicsConfig(assays=ASSAYS)
    print("[Multi-Assay Mode] No multiomics config found, using defaults")

OUTPUT_DIR = MULTIOMICS_CONFIG.output_dir

# Snakemake provides the 'workflow' object - access cores from command line -c flag
CORES = workflow.cores if hasattr(workflow, 'cores') else 1
CORES_PER_ASSAY = max(1, CORES // len(ASSAYS)) if ASSAYS else CORES

# Get workflow arguments from config (passed by seqnado CLI)
# workflow.config_settings.config is the dict containing config values
WORKFLOW_ARGS = workflow.config_settings.config.get('workflow_args', '--rerun-incomplete --printshellcmds')


include: "rules/multiomics/all.smk"

MULTIOMICS_OUTPUT = MultiomicsOutput(output_dir=OUTPUT_DIR)

rule all:
    input:
        MULTIOMICS_OUTPUT.all_outputs
    default_target: True
