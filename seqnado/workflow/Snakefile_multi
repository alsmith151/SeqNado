import os
from pathlib import Path
import glob
import yaml

from seqnado.cli import config
from seqnado.config.multiomics import find_assay_configs

################################
# Auto-detect assay configs
################################

# Discover available assays
ASSAY_CONFIGS, METADATA_FILES = find_assay_configs(Path("."))
ASSAYS = sorted(list(ASSAY_CONFIGS.keys()))

if not ASSAYS:
    raise ValueError(
        "No config_*.yaml files found in the current directory. "
        "Please create config files using 'seqnado config <assay>'"
    )

print(f"[Multi-Assay Mode] Detected {len(ASSAYS)} assay(s): {', '.join(ASSAYS)}")


################################
# Configuration
################################

OUTPUT_DIR = "seqnado_output/"

# Snakemake provides the 'workflow' object - access cores from command line -c flag
CORES = workflow.cores if hasattr(workflow, 'cores') else 1
CORES_PER_ASSAY = max(1, CORES // len(ASSAYS)) if ASSAYS else CORES

# Get workflow arguments from config (passed by seqnado CLI)
# workflow.config_settings.config is the dict containing config values
WORKFLOW_ARGS = workflow.config_settings.config.get('workflow_args', '--rerun-incomplete --printshellcmds')


include: "rules/multiomics/all.smk"

rule all:
    input:
        "multi_assay_summary.txt"
    default_target: True
