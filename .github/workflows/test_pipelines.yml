name: Pipeline Tests

on: 
  push

jobs:
  test-pipelines:
    name: Test Pipeline - ${{ matrix.assay }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        assay: 
          - atac
          - cat
          - chip
          - chip-rx
          - mcc
          - meth
          - rna
          - rna-rx
          - snp
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Free up disk space before installations
        run: |
          echo "Freeing up disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Setup Conda environment and install SeqNado
        uses: conda-incubator/setup-miniconda@v3
        with:
          environment-file: testing.yml
          miniforge-version: latest
          use-mamba: true

      - name: Clean up conda cache before container pulls
        shell: bash -el {0}
        run: |
          echo "Cleaning conda cache to free space for containers..."
          mamba clean --all -y

      - name: Install SeqNado package
        shell: bash -el {0}
        run: |
          pip install .

          python -c "import seqnado; print(f'SeqNado installed at: {seqnado.__file__}')"
          which seqnado
          python -c "import pytest; print(f'pytest version: {pytest.__version__}')"

      - name: Setup Apptainer runtime
        uses: eWaterCycle/setup-apptainer@v2
        with:
          apptainer-version: 1.3.4

      - name: Ensure files are available
        run: |
          mkdir -p /home/runner/miniconda3/envs/test/lib/python3.12/site-packages/tests/data/
          cp tests/data/plotting_coordinates.bed /home/runner/miniconda3/envs/test/lib/python3.12/site-packages/tests/data/
          cp tests/data/hg38_genes.bed /home/runner/miniconda3/envs/test/lib/python3.12/site-packages/tests/data/

      - name: Setup Apptainer directories
        shell: bash -el {0}
        run: |
          mkdir -p "${{ github.workspace }}/.apptainer/cache"
          mkdir -p "${{ github.workspace }}/.apptainer/tmp"

          echo "Apptainer cache: ${{ github.workspace }}/.apptainer/cache"
          echo "Apptainer temp: ${{ github.workspace }}/.apptainer/tmp"

      - name: Pre-pull containers to avoid parallel download conflicts
        shell: bash -el {0}
        env:
          APPTAINER_CACHEDIR: "${{ github.workspace }}/.apptainer/cache"
          APPTAINER_TMPDIR: "${{ github.workspace }}/.apptainer/tmp"
        run: |
          echo "Pre-pulling all containers to avoid disk space issues with parallel pulls..."
          apptainer remote add --no-login SylabsCloud cloud.sylabs.io
          apptainer remote use SylabsCloud

          # Pull containers directly to the cache directory that Snakemake will use
          cd "${{ github.workspace }}/.apptainer/cache"

          echo "Pulling main pipeline container..."
          apptainer pull oras://ghcr.io/alsmith151/seqnado_pipeline:latest

          echo "Pulling ML container..."
          apptainer pull oras://ghcr.io/alsmith151/seqnado_ml_cpu:latest

          echo "Pulling MACS2 container..."
          apptainer pull docker://quay.io/biocontainers/macs2:2.1.1.20160309--py27r3.3.1_1

          echo "Pulling PlotNado container..."
          apptainer pull library://asmith151/plotnado/plotnado

          echo "All containers pulled successfully:"
          ls -lh *.sif

      - name: Run SeqNado pipeline test for ${{ matrix.assay }}
        shell: bash -el {0}
        env:
          APPTAINER_CACHEDIR: "${{ github.workspace }}/.apptainer/cache"
          APPTAINER_TMPDIR: "${{ github.workspace }}/.apptainer/tmp"
          APPTAINER_DISABLE_CACHE: "false"
          SEQNADO_CONFIG: "${{ github.workspace }}/tests/genome_config.json"
        run: |
          python -m pytest tests/pipeline/test_pipelines.py::test_pipeline -vv \
          -s --cores 4 --run-pipeline --assays ${{ matrix.assay }}