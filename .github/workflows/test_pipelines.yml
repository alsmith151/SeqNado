name: Python package

on:
  push:
  pull_request:

jobs:
  prepare-images:
    runs-on: ubuntu-latest
    env:
      APPTAINER_CACHEDIR: ${{ github.workspace }}/apptainer-cache
    steps:
      - uses: actions/checkout@v3

      - name: Setup Apptainer
        uses: eWaterCycle/setup-apptainer@v2
        with:
          apptainer-version: 1.3.4

      - name: Configure Sylabs remote
        run: |
          apptainer remote add --no-login SylabsCloud cloud.sylabs.io || true
          apptainer remote use SylabsCloud

      - name: Cache Apptainer images
        id: cache-singularity
        uses: actions/cache@v3
        with:
          path: ${{ env.APPTAINER_CACHEDIR }}
          key: apptainer-cache-${{ hashFiles('**/*.sif') }}
          restore-keys: |
            apptainer-cache-

      - name: Pull all required images
        if: steps.cache-singularity.outputs.cache-hit != 'true'
        run: |
          mkdir -p "$APPTAINER_CACHEDIR"
          images=(
            library://asmith151/seqnado/seqnado_pipeline:latest
            library://asmith151/seqnado/seqnado_extra:latest
            library://asmith151/seqnado/seqnado_report:latest
            library://cchahrou/seqnado/seqnado_meth.sif:latest
            library://asmith151/lanceotron/lanceotron-mcc:latest
            library://asmith151/seqnado/seqnado_mcc:latest
          )
          for img in "${images[@]}"; do
            APPTAINER_CACHEDIR="$APPTAINER_CACHEDIR" apptainer pull $img
          done

  setup-env:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Cache Conda & pip dependencies
        id: cache-conda
        uses: actions/cache@v3
        with:
          path: |
            ~/.conda/pkgs
            ~/.cache/pip
          key: conda-deps-${{ hashFiles('**/testing.yml') }}
          restore-keys: |
            conda-deps-

      - name: Setup Mamba environment
        uses: conda-incubator/setup-miniconda@v3
        with:
          environment-file: testing.yml
          miniforge-version: latest
          auto-activate-base: true

      - name: Update environment with dependencies
        run: |
          conda env update --name base --file testing.yml --prune

  Test:
    needs: [prepare-images, setup-env]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test: ["config", "design", "pipeline"]
        assay: ["atac", "chip-rx", "chip", "rna-rx", "rna", "snp", "cat", "meth", "mcc"]
    env:
      APPTAINER_CACHEDIR: ${{ github.workspace }}/apptainer-cache

    steps:
      - uses: actions/checkout@v3

      - name: Download Apptainer cache
        if: matrix.test == 'pipeline'
        uses: actions/cache@v3
        with:
          path: ${{ env.APPTAINER_CACHEDIR }}
          key: apptainer-cache-${{ hashFiles('**/*.sif') }}
          restore-keys: |
            apptainer-cache-

      - name: Use Conda dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.conda/pkgs
            ~/.cache/pip
          key: conda-deps-${{ hashFiles('**/testing.yml') }}
          restore-keys: |
            conda-deps-

      - name: Activate environment
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true

      - name: Install package fresh
        run: pip install --no-cache-dir .

      - name: Configure Sylabs remote
        if: matrix.test == 'pipeline'
        run: |
          apptainer remote add --no-login SylabsCloud cloud.sylabs.io || true
          apptainer remote use SylabsCloud

      - name: Run pytest
        shell: bash
        env:
          TMPDIR: /tmp
          SEQNADO_CONFIG: ${{ github.workspace }}/tests/genome_config.json
        run: |
          pytest tests/test_pipelines.py::test_${{ matrix.test }}[${{ matrix.assay }}] -vv -s --cores 4