name: Multi-Assay Test

on: 
  push
jobs:
  test-multiassay:
    name: Test Multi-Assay Pipeline
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Setup Conda environment and install SeqNado
        uses: conda-incubator/setup-miniconda@v3
        with:
          environment-file: testing.yml
          miniforge-version: latest
          use-mamba: true

      - name: Install SeqNado package
        shell: bash -el {0}
        run: |
          pip install .

          # Remove SLURM plugin for testing (not available in GitHub Actions)
          pip uninstall -y snakemake-executor-plugin-slurm

          # Verify installation
          python -c "import seqnado; print(f'SeqNado installed at: {seqnado.__file__}')"
          which seqnado
          python -c "import pytest; print(f'pytest version: {pytest.__version__}')"

      - name: Setup Apptainer runtime
        uses: eWaterCycle/setup-apptainer@v2
        with:
          apptainer-version: 1.3.4

      - name: Ensure files are available
        run: |
          mkdir -p /home/runner/miniconda3/envs/test/lib/python3.12/site-packages/tests/data/
          cp tests/data/plotting_coordinates.bed /home/runner/miniconda3/envs/test/lib/python3.12/site-packages/tests/data/
          cp tests/data/hg38_genes.bed /home/runner/miniconda3/envs/test/lib/python3.12/site-packages/tests/data/

      - name: Setup Apptainer cache and pre-pull container
        shell: bash -el {0}
        env:
          APPTAINER_CACHEDIR: "${{ github.workspace }}/.apptainer/cache"
        run: |
          mkdir -p "$APPTAINER_CACHEDIR"
          echo "Apptainer cache directory: $APPTAINER_CACHEDIR"

          # Pre-pull the container image once to avoid simultaneous pulls during parallel execution
          apptainer pull --force oras://ghcr.io/alsmith151/seqnado_pipeline:latest

          # Verify the image was pulled successfully
          ls -lh seqnado_pipeline_latest.sif

      - name: Run SeqNado pipeline test for Multi-Assay
        shell: bash -el {0}
        env:
          TMPDIR: /tmp
          APPTAINER_CACHEDIR: "${{ github.workspace }}/.apptainer/cache"
          SEQNADO_CONFIG: "${{ github.workspace }}/tests/genome_config.json"
        run: |
          python -m pytest tests/pipeline/test_pipeline_multi.py -vv -s \
            --cores 4 --run-pipeline
            